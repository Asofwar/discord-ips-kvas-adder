# Скрипт автоматического импорта IP-адресов в IPset

## Описание

Этот скрипт предназначен для автоматизации процесса скачивания, распаковки и обновления списка IP-адресов в IPset с последующим добавлением задания в `crontab`. Задание может быть настроено для выполнения каждый день в 00:00 по МСК или при перезапуске устройства. Скрипт нацелен на роутеры с установленным **[KVAS](https://github.com/qzeleza/kvas)**.

## Функциональность

- **Скачивание архива** с репозитория GitHub.
- **Распаковка содержимого архива** в целевой директории.
- **Присвоение прав на выполнение скриптам** внутри распакованной директории.
- **Добавление задания в crontab** для автоматического обновления IPset:
  - Выполнение каждый день в полночь (00:00 по МСК).
  - Выполнение при каждом перезапуске устройства.
- **Проверка наличия задания** в `crontab` для предотвращения дублирования.

## Структура скрипта

1. **Переменные:**
   - `REPO_URL` — URL архива с репозитория GitHub.
   - `DEST_DIR` — целевая директория для скачивания и распаковки.
   - `ZIP_FILE` — путь к скачанному архиву.
   - `EXTRACTED_DIR` — директория, куда распаковывается содержимое архива.
   - `SCRIPT_TO_RUN` — имя скрипта для запуска IPset (с аргументом `auto`).

2. **Шаги выполнения:**
   - Если существует старая версия распакованного архива, она удаляется.
   - Скачивается архив по указанному URL.
   - Архив распаковывается в целевую директорию.
   - Присваиваются права на выполнение для всех `.sh` файлов.
   - В начале всех `.sh` файлов заменяется путь к оболочке на `#!/opt/bin/bash`.
   - Проверяется наличие строк `SHELL` и `PATH` в crontab. Если их нет, они добавляются.
   - Проверяется наличие задания в `crontab`:
     - Если задание уже существует, новое задание не добавляется.
     - Если задание не найдено, предлагается выбор между выполнением в полночь или при перезапуске устройства.
   - Обновлённый crontab сохраняется.

## Как использовать

1. Скачайте или клонируйте репозиторий на ваше устройство.
2. Убедитесь, что у вас установлены все необходимые зависимости (например, `curl`, `unzip` и `bash`).
3. Запустите скрипт:
    ```bash
    ./kvas-ipset-adder.sh
    ```
4. Следуйте инструкциям в терминале:
   - Если задание на обновление IPset уже существует, скрипт сообщит вам об этом.
   - Если задание не найдено, вам будет предложено выбрать время для его выполнения (полночь или перезапуск).

## Пример использования crontab

**Выполнение при каждом перезапуске устройства:**
    ```crontab
    SHELL=/opt/bin/bash
    PATH=/opt/bin:/usr/sbin:/usr/bin:/bin:/sbin:/opt/sbin
    @reboot cd /opt/tmp/discord-voice-ips-light && /opt/bin/bash ipset-adder.sh auto
    ```
**Выполнение каждый день в 00:00 по МСК:**
    ```crontab
    SHELL=/opt/bin/bash
    PATH=/opt/bin:/usr/sbin:/usr/bin:/bin:/sbin:/opt/sbin
    0 0 * * * cd /opt/tmp/discord-voice-ips-light && /opt/bin/bash ipset-adder.sh auto
    ```

## В планах допилить следующее

- `ipset-adder.sh`: парсинг существующих списков на основе регулярки ниже и предложение выбрать список, в который будет осуществляться импорт:
    ```bash
    ipset list -n | grep -vE '(NDM|UPNP)'
    ```
- `ipset-adder.sh`: добавить сценарий аналогичный `auto` для передачи имени списка в качестве аргумента
- `kvas-ipset-adder.sh`: добавление возможности передать аргумент, который будет подставляться в крон задании в качестве аргумента для `ipset-adder.sh`:
    ```bash
    SCRIPT_TO_RUN="ipset-adder.sh auto $1"
    ...
    "0 0 * * * cd $EXTRACTED_DIR && /opt/bin/bash $SCRIPT_TO_RUN"
    ```
---
